<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receive Notification</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // Firebase-Konfiguration
    const firebaseConfig = {
        apiKey: "AIzaSyC9fRuO8kTd5ttT5pu-dlsO157DY_H7NgE",
        authDomain: "pushcoal-745bc.firebaseapp.com",
        databaseURL: "https://pushcoal-745bc-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "pushcoal-745bc",
        storageBucket: "pushcoal-745bc.firebasestorage.app",
        messagingSenderId: "592638766918",
        appId: "1:592638766918:web:10a98c5f87a563c9823f47",
        measurementId: "G-W16QRE2BFL"
    };

    // Firebase initialisieren
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Funktion, um die Zeitdifferenz in eine menschenlesbare Form umzuwandeln (nur Minuten und Stunden)
    function timeAgo(timestamp) {
        const now = new Date();

        // Füge das heutige Datum zum Timestamp hinzu
        const today = new Date().toISOString().split('T')[0]; // Holen des heutigen Datums (YYYY-MM-DD)
        const timeParts = timestamp.split(':'); // Teile den timestamp in Stunden, Minuten und Sekunden
        const formattedTimestamp = today + 'T' + timestamp; // Kombiniere Datum und Uhrzeit

        // Erstelle ein Date-Objekt aus dem Timestamp
        const time = new Date(formattedTimestamp);

        const diffInSeconds = Math.floor((now - time) / 1000); // Zeitdifferenz in Sekunden

        const minutes = Math.floor(diffInSeconds / 60) % 60;
        const hours = Math.floor(diffInSeconds / 3600);

        // Rückgabe der Zeitangabe basierend auf der Differenz (nur Minuten und Stunden)
        if (diffInSeconds < 60) {
            return `vor weniger als 1 Minute`;
        } else if (minutes < 60) {
            return `vor ${minutes} Minuten`;
        } else if (hours < 24) {
            return `vor ${hours} Stunden`;
        } else {
            return 'vor mehr als 24 Stunden';
        }
    }

    // Funktion, die Benachrichtigung anzeigt
    function showNotification(message, tableNumber, timestamp) {
        // Neue Benachrichtigung erstellen
        const notificationsList = document.getElementById('notifications-list');

        // Neues Benachrichtigungs-Div erstellen
        const newNotification = document.createElement('div');
        newNotification.classList.add('notification-item');

        // Umwandeln des Zeitstempels in eine lesbare Form (vor 1 Minute, vor 5 Stunden)
        const readableTimestamp = timeAgo(timestamp);

        // Inhalt der Benachrichtigung
        newNotification.innerHTML = `
            <div id="tableNumber">⚠️ Tisch: ${tableNumber}</div>
            <div id="message"> ${message}</div>
            <div id="timestamp">Zeit: <span id="timeAgo">${readableTimestamp}</span></div>
        `;

        // Benachrichtigung zur Liste hinzufügen
        notificationsList.prepend(newNotification);

        // Hintergrundanimation starten (Flashing)
        newNotification.classList.add('flashing');

        // Flashing wiederholen alle 5s, falls nicht angeklickt
        let flashInterval = setInterval(() => {
            if (!newNotification.classList.contains('completed')) {
                newNotification.classList.add('flashing');
                setTimeout(() => newNotification.classList.remove('flashing'), 300); // Flash für 0.3s
            }
        }, 5000); // Alle 5 Sekunden

        // Startet den Timer für die Zeitdifferenz (Minute und Stunden)
        let startTime = new Date();
        let timeInterval = setInterval(() => {
            // Berechne die Zeitdifferenz in Minuten und Stunden
            const diffInSeconds = Math.floor((new Date() - startTime) / 1000); // Zeitdifferenz in Sekunden

            const minutes = Math.floor(diffInSeconds / 60) % 60;
            const hours = Math.floor(diffInSeconds / 3600);

            let timeAgoText = '';
            if (diffInSeconds < 60) {
                timeAgoText = `vor weniger als 1 Minute`;
            } else if (minutes < 60) {
                timeAgoText = `vor ${minutes} Minuten`;
            } else if (hours < 24) {
                timeAgoText = `vor ${hours} Stunden`;
            } else {
                timeAgoText = 'vor mehr als 24 Stunden';
            }

            // Aktualisiere den Timestamp in der Benachrichtigung
            newNotification.querySelector('#timeAgo').innerText = timeAgoText;
        }, 60000); // Aktualisierung alle 1 Minute

        // Klick-Event für die Benachrichtigung
        newNotification.addEventListener('click', () => {
            newNotification.classList.add('completed'); // Markiert den Task als erledigt
            newNotification.style.backgroundColor = 'green'; // Verändert den Hintergrund zu grün
            clearInterval(flashInterval); // Stoppt den Flashing-Intervall, wenn angeklickt

            // Der Timer für die Zeitdifferenz läuft weiter und zeigt weiterhin die aktualisierte Zeit an
        });
    }

    // Firebase-Datenbank überwachen
    const notificationRef = ref(db, 'notifications');
    onValue(notificationRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            const message = data.message || 'Keine Nachricht';
            const tableNumber = data.tableNumber || 'Unbekannt';
            const timestamp = data.timestamp || 'Unbekannt';

            // Zeige die Benachrichtigung und starte die Animation
            showNotification(message, tableNumber, timestamp);
        }
    });
</script>

<h1>Empfänger für Benachrichtigungen</h1>

<!-- Liste der Benachrichtigungen -->
<div id="notifications-list"></div>

</body>
</html>
